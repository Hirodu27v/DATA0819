Preparing Data - Cleaning Data with OpenRefine 
OpenRefineの使い方と、データセットをきれいにする素晴らしい機能について説明します。openrefine.orgから"Download"をクリックします。
OSに合わせたバージョンをダウンロードしてください。Windows、Mac、Linuxに対応しています。
ダウンロードしたらダイヤモンド形ロゴをクリックして開いてみましょう。Windowsの場合は黒い画面が開きますが、気にしないでください。アプリケーションを実行しているので、そのままにしておきます。
それでは、サラ・コーエンが作った、OpenRefineを使用してデータセットをクリーンアップするチュートリアルを使ってみます。
cloud data prepと同じデータセットを使いますが、OpenRefineは似て非なるアプローチを用います。
これは当時ニューヨーク・タイムズの記者だったサラが2016年にデンバーで行われたNICARのコンピュータ支援報道の会議で発表したデータセットです。私も見ていたのですが、素晴らしいワークショップでした。
彼女はニューヨーク州の高齢者医療保険制度からデータセットを構築し、どの企業を調査対象とするか決めようと思い立ちました。
彼女は、月ごとのスプレッドシートをまとめたようなこの大きなスプレッドシートを作りました。そして、OpenRefineで、正規表現を中心にデータを整えました。
今日、そのいくつかを使いますが、常に使うわけではありません。
これが目標とするスプレッドシートで、プランと郡の合計登録数、月と年の列が並んでいます。このように。
これを実現するためにOpenRefineを使います。サラのチュートリアルもここにあります。OpenRefineの高度な機能についても載っています。おいおい慣れていきましょう。
OpenRefineを開くと、コンピュータ上でOpenRefineが実行されます。ウェブ上では動いていません。ユーザーが行う操作はすべてコンピュータ上に保持されます。OpenRefineを使用するために、インターネットに接続している必要はありません。Webブラウザを使用しますが、別のアドレスを使用していることに注意してください。このアドレスはローカルマシンを指しています。
OpenRefineを開くと、ここにある様々なソースやGoogleデータから選択できるように、プロジェクトを作成できるインターフェースがあるのが分かりますか。
リップボードにデータを貼り付けたり、URLを書き込んだり、コンピュータからファイルを取得したり、既存のプロジェクトを開いたり、他のファイルからプロジェクトをインポートしたりできます。言語などの設定もあります。
プロジェクトを作成します。このプロジェクトは、Sarahが作成したExcelファイルから作成しました。ここでファイルを選択します。OpenRefineはこのコンピュータにあるほとんどすべてのデータベースファイル形式を開けます。
DSV、CSV、SVファイル、Excel、JSON、XML、RDFファイル、さらにはGoogleデータ文書もサポートされています。かなり広範囲なので試してみてください。
[次へ] をクリックすると、ここにあるすべての項目のプレビューが表示されます。このプロジェクトに「ニューヨーク州の医療保険制度」という名前を付けます。
プレビューが表示されるので、エンコーディングが正しいかどうかを確認できます。「Excelファイルとしてデータを解析する」と表示が出るので、ファイル形式を確認します。
ここに指示画面が出ています。ここでチェックを外すのは、最初の行を列名とするためです。ここでは、列の冒頭は見出し行ではありません。
したがって、ここから列を始めます。OpenRefineで行うことはすべて、このインタフェースで行われます。左側にフィルタとファセットメニューがありますが、これについて少し説明します。
右側には常に太字で現在作業中のレコード数が表示されます。行やレコードに切り替えることもできます。今は行を使用します。
たとえば、ここに表示されている6664行は、ここに表示されている行と同じです。また、50を入力するとその行が表示されます。
任意のプロジェクトをいつでもエクスポートできます。ExcelファイルでもHTMLテーブルでもCSVファイルでも何でも構いません。
ファイルを移動することもできます。OpenRefineのすべてのオプションは列の一番上にあり、必要な操作を特定の列に対して行うことができます。また、必要に応じてすべての列に適用することもできます。
最初に行うことは、この乱雑なデータセットをこのような整理されたデータセットに変換することです。
年の列を作成するには、この列からこの数値を抽出し、新しい列に追加する必要があります。この矢印をクリックします。「列を編集」をクリックします。そして「この列に基づいて列を追加する」。新しいウィンドウが開きます。
ここで変換ができます。ここでは正規表現を使用します。この新しい列に「年」という名前を付けます。
「探す」と入力して、必要なものを検索します。ここで使用しているのは、正規表現をスラッシュで開始し、スラッシュで終了する方法です。値の中にある4桁の数字を私に返します。
これを削除すると、リストが表示されます。プログラミングでは、通常、リストの最初の項目は位置ゼロです。
これは、この列から年を抽出するための正規表現のようなもので、「ok」をクリックすると、その年を含む新しい列が作成されます。
ここまでの1か月を抽出したいのですが、その月は少し複雑です。月は「列を編集」、「この列に基づいて列を追加する」で、ここで使うのはもう少し複雑ですが、かなりわかりやすいです。
先頭にはスラッシュを付け、末尾にはスラッシュを付けます。ここを見てください、それはNYS、単語、そして数字の順です。
ここで追加したのは、ここで追加したのは、これらのブラケットですが、カンマとスペース、ブラケット、カンマとスペースがあり、NYSの後にカンマまたはスペースが何度でも来ても構いません。これがプラスの意味です。
したがって、タイプミスでスペースが二つあってもすべてのケースを取得できます。表現をよりよく理解できるように、ここに置きました。
ここで何が起こっているかというと緑で示しているのは1月という言葉だけです。正規表現の括弧は、中にあるものをすべて取り込むことを意味します。4桁の前にある空白やコンマの間で起こっている単語を捉えています。
「１月」を取り出しました。列の名前を「月」に変更します。ここにすべての値を記入する必要があります。2009年1月から始まっています。
ここには2010年、さらにほかの年があるのも分かりますね。2013年の12月です。値をいちいち入力するのは気が重いでしょう。
これをOpenRefineで行うのは非常に簡単です。例えばここをクリックしてください。「セルの編集」を選択し、「下へ」を選択すれば完了です。
「セルの編集」を選択して「埋める」を選択すると、同じ年が一年間入りました。次に、クリーニングを開始し、フィルタリングを行います。
まず、合計の行を削除します。テキストフィルタを作成し、「合計」と入力します。ここに合計という文字がある74行全てが表示されます。次に、「全部」でここをクリックし、次に「行を編集」、「一致するすべての行を削除する」で、この74行を削除します。
これをさらに数回実行して、より適切なクリーニングを実行します。空のセルを削除するために、「ファセット」、「カスタマイズされたファセット」、「空白によるファセット」の順に実行します。
ファセットはカラム内のカテゴリを識別する方法です。ファセットを作成することで、同じ値を持つセルを識別してグループ化し、カテゴリを可視化できます。
ここでは、空白で行います。次に、テキストで行います。
ここでは、nullまたは空のストリングを意味する「空白によるファセット」を作成します。この場合、842行がブランクであることが示されます。
ここをクリックすると、842個の一致する行が表示されます。これらの行はすべて削除します。これらは最終的なデータセットには必要ないからです。これらの行をすべて削除し、ファセットをクリアします。
郡と登録があります。フィルタを作成します。それと登録を削除します。ここで一致する行をすべて削除します。彼らはみな同じプランに加入しているので、プランの名前も記入したいです。
「セルを編集する」、そして、記入します。ここで、この列からも合計を削除します。見た目はずっと良くなりましたが、ここでも空白でファセットを作れるものがあります。
これをクリアしてください。列の名前を変更します。この列は「プラン」、この列は「郡」そしてこれは「合計」です。
ここでテキストファセットを作成してプランの内容で分類できます。テキストファセットを作成している郡が表示され、ここではどの郡がリストされているか、またその郡が何回リストされているかを確認できます。
ニューヨークのように最多記録を出した郡を見ることができます。プランのスペルが正しいかどうかをチェックすることもできます。
Eddy Seniorcareは一続きになっているところもあれば、分割されているところもあります。クラスタと呼ばれる非常に強力な機能があります。「cluster」 をクリックすると、スペルミスを識別しようとします。
詳しくはこちらを参照してください。メソッドやキー関数もありますが、酷似した綴りの名前を見つけようとします。Eddy Seniorcareの例では、このクラスタを参照して、ここで何が起こっているかを確認できます。
こちらではEddy Senior CareとEddie Seniorcareが混在しています。Eddy Senior Careのスペルが正しいのでこれを結合して「選択したものをマージしてクラスタし直す」を使用し、一瞬にして171個のセルを編集して間違いのタイプを修正します。
ここで方法を変更して、どちらがうまくいくかを確認できますが、これは入力ミスを修正するための強力なツールでもあります。
れで問題ないと思われる場合は、テーブルを任意の形式 (CSVまたはExcelファイルまたはTSV) に書き出すことができます。
ですから、他のバージョンのOpenRefineで開くこともできます。CSVでエクスポートします。これが最終的なCSVファイルです。これが使えるのを見てください。
OpenRefineの簡単な紹介でした。使用しているシステムに最適なバージョンをダウンロードし、データのクリーニングを始めましょう。
フォーラムに疑問を投稿していただければ、お答えします。
